<%- include('partials/header', {title: 'Settings'}) %>

<%- include('partials/mobile-header') %>

<style>
.data-table tbody tr {
  border-bottom: 1px solid var(--border-color);
  transition: background 0.2s;
}

.data-table tbody tr:last-child {
  border-bottom: none;
}

.data-table tbody tr:hover {
  background: var(--card-bg);
}

.data-table td {
  padding: 0.75rem;
  color: var(--text-secondary);
  vertical-align: middle;
}

.badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
}

.badge-success {
  background: #D1FAE5;
  color: #065F46;
}

.badge-muted {
  background: var(--card-bg);
  color: var(--text-muted);
}

.btn-icon {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  transition: all 0.2s;
}

.btn-icon:hover {
  background: var(--card-bg);
  color: var(--text-primary);
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--drawer-overlay);
  z-index: 2000;
  display: none;
  animation: fadeIn 0.2s ease-out;
}

.modal-overlay.active {
  display: block;
}

.modal-dialog {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--surface-color);
  border-radius: 12px;
  box-shadow:
    0 20px 25px -5px rgba(0, 0, 0, 0.1),
    0 10px 10px -5px rgba(0, 0, 0, 0.04);
  z-index: 2001;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  display: none;
  animation: slideIn 0.3s ease-out;
}

.modal-dialog.active {
  display: block;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid var(--border-color);
}

.modal-header h3 {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text-primary);
}

.modal-close {
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 0.5rem;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  transition: all 0.2s;
  font-size: 1.25rem;
}

.modal-close:hover {
  background: var(--background-color);
  color: var(--text-primary);
}

.modal-content {
  padding: 1.5rem;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translate(-50%, -48%);
  }
  to {
    opacity: 1;
    transform: translate(-50%, -50%);
  }
}

.test-result-success {
  padding: 1rem;
  background: #d1fae5;
  border: 1px solid #10b981;
  border-radius: 8px;
  color: #065f46;
}

.test-result-error {
  padding: 1rem;
  background: #fee2e2;
  border: 1px solid #ef4444;
  border-radius: 8px;
  color: #991b1b;
}

.test-result-info {
  padding: 1rem;
  background: #dbeafe;
  border: 1px solid #3b82f6;
  border-radius: 8px;
  color: #1e40af;
}

[data-theme="dark"] .test-result-success {
  background: rgba(16, 185, 129, 0.1);
  border-color: #10b981;
  color: #6ee7b7;
}

[data-theme="dark"] .test-result-error {
  background: rgba(239, 68, 68, 0.1);
  border-color: #ef4444;
  color: #fca5a5;
}

[data-theme="dark"] .test-result-info {
  background: rgba(59, 130, 246, 0.1);
  border-color: #3b82f6;
  color: #93c5fd;
}
</style>

<div class="page-wrapper">
  <%- include('partials/sidebar', { currentPage: 'settings', websites: websites, currentWebsite: null, user: user }) %>
  <div class="main-container">
    <div class="main-header">
      <div class="header-content">
        <div class="header-title">
          <h1>App Settings</h1>
          <p>Manage your application preferences</p>
        </div>
      </div>
    </div>
    
    <main class="main-content" style="padding-top: 1rem;">
      <div class="tabs-card">
        <div class="tabs-header">
          <button class="tab-button active" data-tab="appearance">
            <i class="fa-solid fa-palette"></i>
            <span>Appearance</span>
          </button>
          <button class="tab-button" data-tab="dashboard">
            <i class="fa-solid fa-chart-line"></i>
            <span>Dashboard</span>
          </button>
          <button class="tab-button" data-tab="privacy">
            <i class="fa-solid fa-shield-halved"></i>
            <span>Privacy</span>
          </button>
          <button class="tab-button" data-tab="api-keys">
            <i class="fa-solid fa-key"></i>
            <span>API Keys</span>
          </button>
          <% if (apiKeys?.find(k => k.service === 'resend' && k.isActive)) { %>
            <button class="tab-button" data-tab="notifications">
              <i class="fa-solid fa-bell"></i>
              <span>Notifications</span>
            </button>
          <% } %>
          <button class="tab-button" data-tab="database">
            <i class="fa-solid fa-database"></i>
            <span>Database</span>
          </button>
        </div>

        <div class="tabs-body">
          <section class="tab-panel active" id="appearance-panel">
            <div class="settings-group">
              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Dark Mode</div>
                  <div class="settings-option-description">Switch between light and dark themes.</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="theme-toggle">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Toast Notifications</div>
                  <div class="settings-option-description">Show small notifications when settings are updated.</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="toasts-toggle">
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
          </section>

          <section class="tab-panel" id="dashboard-panel">
            <div class="settings-group">
              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Auto Refresh</div>
                  <div class="settings-option-description">Automatically pull the latest dashboard metrics.</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="auto-refresh-toggle">
                  <span class="toggle-slider"></span>
                </label>
              </div>

              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Refresh Interval</div>
                  <div class="settings-option-description">Choose how often we refresh the data.</div>
                </div>
                <select id="refresh-rate-select" class="settings-select">
                  <option value="0">Instant</option>
                  <option value="10000">10 seconds</option>
                  <option value="30000">30 seconds</option>
                  <option value="60000">1 minute</option>
                  <option value="300000">5 minutes</option>
                  <option value="900000">15 minutes</option>
                  <option value="1800000">30 minutes</option>
                </select>
              </div>
              
              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Data Period</div>
                  <div class="settings-option-description">Number of trailing days included in reports.</div>
                </div>
                <select id="data-period-select" class="settings-select">
                  <option value="7">7 days</option>
                  <option value="15">15 days</option>
                  <option value="30">30 days</option>
                </select>
              </div>

              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Results Per Card</div>
                  <div class="settings-option-description">How many entries to surface inside each report card.</div>
                </div>
                <select id="results-limit-select" class="settings-select">
                  <option value="5">5 results</option>
                  <option value="10">10 results</option>
                  <option value="25">25 results</option>
                </select>
              </div>
            </div>
          </section>

          <section class="tab-panel" id="privacy-panel">
            <div class="settings-group">
              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Store Raw IP Addresses</div>
                  <div class="settings-option-description">Enable to store and display full IP addresses. When disabled, only hashed visitor IDs are stored for privacy.</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="store-raw-ip-toggle" <%= appSettings?.storeRawIp ? 'checked' : '' %>>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Discard Short Sessions</div>
                  <div class="settings-option-description">When enabled, sessions with a duration of less than 1 second will be automatically discarded and not stored in the database.</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="discard-short-sessions-toggle" <%= appSettings?.discardShortSessions ? 'checked' : '' %>>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
          </section>

          <section class="tab-panel" id="api-keys-panel">
            <div class="settings-group">
              <div class="api-key-section" style="padding: 1rem 0;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                  <h4 style="margin: 0; color: var(--text-primary);">
                    <i class="fa-brands fa-google" style="margin-right: 0.5rem; color: #4285f4;"></i>
                    Google PageSpeed Insights
                  </h4>
                  <% 
                    const pagespeedKey = apiKeys?.find(k => k.service === 'google_pagespeed' && k.isActive);
                  %>
                  <% if (pagespeedKey) { %>
                    <span style="color: var(--success); font-size: 0.875rem;">
                      <i class="fa-solid fa-circle-check"></i> Configured
                    </span>
                  <% } else { %>
                    <span style="color: var(--text-muted); font-size: 0.875rem;">
                      <i class="fa-solid fa-circle-xmark"></i> Not configured
                    </span>
                  <% } %>
                </div>
                
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                  Required for comprehensive SEO and performance analysis. 
                  <a href="https://developers.google.com/speed/docs/insights/v5/get-started" target="_blank" rel="noopener noreferrer" style="color: var(--primary);">Get your API key</a>
                </p>

                <% if (pagespeedKey) { %>
                  <div style="padding: 1rem; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <span style="font-size: 0.875rem; color: var(--text-secondary);">Key ID: <%= pagespeedKey.id.substring(0, 8) %>...</span>
                      <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary btn-sm" onclick="testPageSpeedConnection()">
                          <i class="fa-solid fa-flask"></i> Test Connection
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteApiKey('<%= pagespeedKey.id %>', 'google_pagespeed')">
                          <i class="fa-solid fa-trash"></i> Remove
                        </button>
                      </div>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                      <span>Used <%= pagespeedKey.usageCount || 0 %> times</span>
                      <% if (pagespeedKey.lastUsed) { %>
                        <span style="margin-left: 1rem;">Last used: <%= new Date(pagespeedKey.lastUsed).toLocaleDateString() %></span>
                      <% } %>
                    </div>
                  </div>
                <% } else { %>
                  <form id="pagespeed-form" onsubmit="addApiKey(event, 'google_pagespeed')" style="display: flex; gap: 0.5rem;">
                    <input type="text" name="apiKey" class="settings-input" placeholder="AIza..." required style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-primary);">
                    <button type="submit" class="btn btn-primary" style="white-space: nowrap;">
                      <i class="fa-solid fa-save"></i> Save Key
                    </button>
                  </form>
                <% } %>
              </div>

              <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 1rem 0;">

              <div class="api-key-section" style="padding: 1rem 0;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                  <h4 style="margin: 0; color: var(--text-primary);">
                    <img src="/img/vendors/chapybara.png" alt="Chapybara" style="width: 24px; height: 24px; margin-right: 0.5rem; vertical-align: middle; border-radius: 4px;">
                    Chapybara IP Intelligence
                  </h4>
                  <% 
                    const chapybaraKey = apiKeys?.find(k => k.service === 'chapybara' && k.isActive);
                  %>
                  <% if (chapybaraKey) { %>
                    <span style="color: var(--success); font-size: 0.875rem;">
                      <i class="fa-solid fa-circle-check"></i> Configured
                    </span>
                  <% } else { %>
                    <span style="color: var(--text-muted); font-size: 0.875rem;">
                      <i class="fa-solid fa-circle-xmark"></i> Not configured
                    </span>
                  <% } %>
                </div>
                
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                  Get detailed IP intelligence including geolocation, ISP, security threat detection, and more. 
                  <a href="https://chapyapi.com" target="_blank" rel="noopener noreferrer" style="color: var(--primary);">Get your API key</a>
                </p>

                <% if (chapybaraKey) { %>
                  <div style="padding: 1rem; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <span style="font-size: 0.875rem; color: var(--text-secondary);">Key ID: <%= chapybaraKey.id.substring(0, 8) %>...</span>
                      <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary btn-sm" onclick="testChapybaraConnection()">
                          <i class="fa-solid fa-flask"></i> Test Connection
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteApiKey('<%= chapybaraKey.id %>', 'chapybara')">
                          <i class="fa-solid fa-trash"></i> Remove
                        </button>
                      </div>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                      <span>Used <%= chapybaraKey.usageCount || 0 %> times</span>
                      <% if (chapybaraKey.lastUsed) { %>
                        <span style="margin-left: 1rem;">Last used: <%= new Date(chapybaraKey.lastUsed).toLocaleDateString() %></span>
                      <% } %>
                    </div>
                  </div>
                <% } else { %>
                  <form id="chapybara-form" onsubmit="addApiKey(event, 'chapybara')" style="display: flex; gap: 0.5rem;">
                    <input type="text" name="apiKey" class="settings-input" placeholder="ck_..." required style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-primary);">
                    <button type="submit" class="btn btn-primary" style="white-space: nowrap;">
                      <i class="fa-solid fa-save"></i> Save Key
                    </button>
                  </form>
                <% } %>
              </div>

              <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 1rem 0;">

              <div class="api-key-section" style="padding: 1rem 0;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                  <h4 style="margin: 0; color: var(--text-primary);">
                    <img src="/img/vendors/resend.svg" alt="Resend" style="width: 24px; height: 24px; margin-right: 0.5rem; vertical-align: middle; filter: brightness(0) saturate(100%) invert(40%) sepia(95%) saturate(2387%) hue-rotate(210deg) brightness(94%) contrast(95%);">
                    Resend Email Service
                  </h4>
                  <% 
                    const resendKey = apiKeys?.find(k => k.service === 'resend' && k.isActive);
                  %>
                  <% if (resendKey) { %>
                    <span style="color: var(--success); font-size: 0.875rem;">
                      <i class="fa-solid fa-circle-check"></i> Configured
                    </span>
                  <% } else { %>
                    <span style="color: var(--text-muted); font-size: 0.875rem;">
                      <i class="fa-solid fa-circle-xmark"></i> Not configured
                    </span>
                  <% } %>
                </div>
                
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                  Required for sending email notifications about events, visitors, and analytics. 
                  <a href="https://resend.com/api-keys" target="_blank" rel="noopener noreferrer" style="color: var(--primary);">Get your API key</a>
                </p>

                <% if (resendKey) { %>
                  <div style="padding: 1rem; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">Key ID: <%= resendKey.id.substring(0, 8) %>...</div>
                        <% if (resendKey.metadata?.fromEmail) { %>
                          <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">From: <%= resendKey.metadata.fromEmail %></div>
                        <% } %>
                      </div>
                      <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary btn-sm" onclick="testResendConnection()">
                          <i class="fa-solid fa-flask"></i> Test Connection
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteApiKey('<%= resendKey.id %>', 'resend')">
                          <i class="fa-solid fa-trash"></i> Remove
                        </button>
                      </div>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                      <span>Used <%= resendKey.usageCount || 0 %> times</span>
                      <% if (resendKey.lastUsed) { %>
                        <span style="margin-left: 1rem;">Last used: <%= new Date(resendKey.lastUsed).toLocaleDateString() %></span>
                      <% } %>
                    </div>
                  </div>
                <% } else { %>
                  <form id="resend-form" onsubmit="addApiKey(event, 'resend')" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div>
                      <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); font-weight: 500;">API Key</label>
                      <input type="text" name="apiKey" class="settings-input" placeholder="re_..." required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-primary);">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); font-weight: 500;">From Email</label>
                      <input type="email" name="fromEmail" class="settings-input" placeholder="notifications@yourdomain.com" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-primary);">
                      <small style="display: block; margin-top: 0.25rem; color: var(--text-muted); font-size: 0.75rem;">Must be a verified domain in your Resend account</small>
                    </div>
                    <button type="submit" class="btn btn-primary" style="align-self: flex-start;">
                      <i class="fa-solid fa-save"></i> Save Configuration
                    </button>
                  </form>
                <% } %>
              </div>
            </div>
          </section>

          <section class="tab-panel" id="notifications-panel">
            <div class="settings-group">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding: 1rem 0;">
                <div>
                  <h3 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">Notification Rules</h3>
                  <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                    Configure email notifications for important events on your websites.
                  </p>
                </div>
                <button class="btn btn-primary" onclick="showAddNotificationModal()">
                  <i class="fa-solid fa-plus"></i> Add Rule
                </button>
              </div>

              <% if (!apiKeys?.find(k => k.service === 'resend' && k.isActive)) { %>
                <div style="padding: 1.5rem; background: var(--warning-bg, #FEF3C7); border-radius: 8px; border: 1px solid var(--warning-border, #FCD34D); margin-bottom: 1.5rem;">
                  <div style="display: flex; align-items: start; gap: 1rem;">
                    <i class="fa-solid fa-triangle-exclamation" style="color: #F59E0B; font-size: 1.5rem; margin-top: 0.25rem;"></i>
                    <div>
                      <h4 style="margin: 0 0 0.5rem 0; color: #92400E;">Resend API Key Required</h4>
                      <p style="margin: 0; color: #92400E; font-size: 0.875rem;">
                        You need to configure a Resend API key in the <strong>API Keys</strong> tab before you can create notification rules.
                      </p>
                    </div>
                  </div>
                </div>
              <% } %>

              <div id="notifications-table-container">
                <table class="data-table" style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: var(--card-bg); border-bottom: 2px solid var(--border-color);">
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-primary);">Name</th>
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-primary);">Event Type</th>
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-primary);">Recipient</th>
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-primary);">Website</th>
                      <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--text-primary);">Status</th>
                      <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--text-primary);">Triggered</th>
                      <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--text-primary);">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="notifications-table-body">
                    <tr>
                      <td colspan="7" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                        <i class="fa-solid fa-bell-slash" style="font-size: 2rem; opacity: 0.3; display: block; margin-bottom: 0.5rem;"></i>
                        No notification rules configured yet.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <section class="tab-panel" id="database-panel">
            <div class="settings-group">
              <div class="db-management-header">
                <div>
                  <h3>Database Management</h3>
                  <p class="db-management-subtitle">
                    Manage and prune database records. Use with caution - deleted data cannot be recovered.
                  </p>
                </div>
                <button class="btn btn-danger" onclick="showDataManagementDrawer()">
                  <i class="fa-solid fa-database"></i> Manage Data
                </button>
              </div>

              <div class="db-warning-card" style="margin-bottom: 1rem;">
                <div class="db-warning-content">
                  <i class="fa-solid fa-triangle-exclamation"></i>
                  <div>
                    <h4>Warning: Irreversible Action</h4>
                    <p>
                      Deleting records from the database is permanent. Make sure you understand the consequences before proceeding. 
                      This action will remove all data from the selected collections and cannot be undone.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>
</div>

<div class="drawer-overlay" id="notification-drawer-overlay"></div>

<div class="drawer" id="notification-drawer">
  <div class="drawer-header">
    <h2>Add Notification Rule</h2>
    <button class="drawer-close" id="notification-drawer-close"><i class="fa-solid fa-xmark"></i></button>
  </div>
  <div class="drawer-content">
    <form id="notification-form" onsubmit="saveNotificationRule(event)">
      <div class="settings-group">
        <div class="form-group" style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
            Rule Name <span style="color: var(--danger);">*</span>
          </label>
          <input type="text" name="name" class="settings-input" placeholder="e.g., New Visitor Alert" required 
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
        </div>

        <div class="form-group" style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
            Event Type <span style="color: var(--danger);">*</span>
          </label>
          <select name="eventType" class="website-selector" required onchange="handleEventTypeChange(this.value)">
            <option value="">Select an event type...</option>
            <option value="new_visitor">New Visitor Registered</option>
            <option value="custom_event">Custom Event Triggered</option>
            <option value="new_session">New Session Started</option>
            <option value="daily_summary">Daily Summary Report</option>
            <option value="error_threshold">Error Threshold Exceeded</option>
            <option value="uptime_status">Website Uptime Change</option>
          </select>
        </div>

        <div id="custom-event-name-group" class="form-group" style="margin-bottom: 1.5rem; display: none;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
            Custom Event Name <span style="color: var(--danger);">*</span>
          </label>
          <input type="text" name="customEventName" class="settings-input" placeholder="e.g., button_click" 
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
          <small style="display: block; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.875rem;">
            Enter the exact name of the custom event to monitor.
          </small>
        </div>

        <div id="uptime-event-settings" class="form-group" style="margin-bottom: 1.5rem; display: none;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
            Uptime Alert Options
          </label>
          <select name="uptimeNotifyOn" id="uptime-notify-on" class="website-selector">
            <option value="down" selected>Notify when the website goes down</option>
            <option value="up">Notify when the website recovers</option>
            <option value="both">Notify for both downtime and recovery</option>
          </select>
          <small style="display: block; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.875rem;">
            Choose when Skopos should send uptime alerts.
          </small>
        </div>

        <div class="form-group" style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
            Recipient Email <span style="color: var(--danger);">*</span>
          </label>
          <input type="email" name="recipientEmail" class="settings-input" placeholder="you@example.com" required 
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
        </div>

        <div class="form-group" style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
            Website
          </label>
          <select name="website" class="website-selector">
            <option value="">All Websites</option>
            <% if (websites && websites.length > 0) { %>
              <% websites.forEach(site => { %>
                <option value="<%= site.id %>"><%= site.name %></option>
              <% }); %>
            <% } %>
          </select>
          <small style="display: block; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.875rem;">
            Leave empty to apply to all websites.
          </small>
        </div>

        <div style="display: flex; gap: 0.75rem; margin-top: 2rem;">
          <button type="button" class="btn btn-secondary" onclick="closeNotificationDrawer()" style="flex: 1;">Cancel</button>
          <button type="submit" class="btn btn-primary" style="flex: 1;">
            <i class="fa-solid fa-save"></i> Save Rule
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="drawer-overlay" id="data-management-overlay"></div>

<div class="drawer" id="data-management-drawer">
  <div class="drawer-header">
    <h2>Prune Database Records</h2>
    <button class="drawer-close" id="data-management-close"><i class="fa-solid fa-xmark"></i></button>
  </div>
  <div class="drawer-content">
    <div class="db-drawer-container">
      <div class="db-danger-alert">
        <i class="fa-solid fa-exclamation-triangle"></i>
        <div class="db-danger-alert-content">
          <strong>Permanent Data Deletion</strong>
          <span>Selected collections will have <strong>all records permanently deleted</strong>. This cannot be undone.</span>
        </div>
      </div>

      <div class="db-action-buttons">
        <button class="btn btn-secondary" onclick="selectAllCollections()">
          <i class="fa-solid fa-check-double"></i> Select All
        </button>
        <button class="btn btn-secondary" onclick="resetCollectionSelection()">
          <i class="fa-solid fa-rotate-left"></i> Reset
        </button>
      </div>

      <div class="db-collections-grid">
        <div class="db-collection-card" data-collection="api_keys">
          <label class="db-collection-label">
            <input type="checkbox" class="collection-checkbox" data-collection="api_keys">
            <div class="db-collection-content">
              <div class="db-collection-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fa-solid fa-key"></i>
              </div>
              <div class="db-collection-info">
                <h4>API Keys</h4>
                <p>Third-party service credentials</p>
              </div>
            </div>
            <div class="db-collection-check">
              <i class="fa-solid fa-circle-check"></i>
            </div>
          </label>
        </div>
        <div class="db-collection-card" data-collection="events">
          <label class="db-collection-label">
            <input type="checkbox" class="collection-checkbox" data-collection="events">
            <div class="db-collection-content">
              <div class="db-collection-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <i class="fa-solid fa-calendar-check"></i>
              </div>
              <div class="db-collection-info">
                <h4>Events</h4>
                <p>User interactions and page views</p>
              </div>
            </div>
            <div class="db-collection-check">
              <i class="fa-solid fa-circle-check"></i>
            </div>
          </label>
        </div>
        <div class="db-collection-card" data-collection="js_errors">
          <label class="db-collection-label">
            <input type="checkbox" class="collection-checkbox" data-collection="js_errors">
            <div class="db-collection-content">
              <div class="db-collection-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <i class="fa-solid fa-bug"></i>
              </div>
              <div class="db-collection-info">
                <h4>JavaScript Errors</h4>
                <p>Client-side error logs</p>
              </div>
            </div>
            <div class="db-collection-check">
              <i class="fa-solid fa-circle-check"></i>
            </div>
          </label>
        </div>
        <div class="db-collection-card" data-collection="notyf_rules">
          <label class="db-collection-label">
            <input type="checkbox" class="collection-checkbox" data-collection="notyf_rules">
            <div class="db-collection-content">
              <div class="db-collection-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                <i class="fa-solid fa-bell"></i>
              </div>
              <div class="db-collection-info">
                <h4>Notification Rules</h4>
                <p>Email alert configurations</p>
              </div>
            </div>
            <div class="db-collection-check">
              <i class="fa-solid fa-circle-check"></i>
            </div>
          </label>
        </div>

        <div class="db-collection-card" data-collection="seo_data">
          <label class="db-collection-label">
            <input type="checkbox" class="collection-checkbox" data-collection="seo_data">
            <div class="db-collection-content">
              <div class="db-collection-icon" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                <i class="fa-solid fa-magnifying-glass-chart"></i>
              </div>
              <div class="db-collection-info">
                <h4>SEO Data</h4>
                <p>Search engine optimization metrics</p>
              </div>
            </div>
            <div class="db-collection-check">
              <i class="fa-solid fa-circle-check"></i>
            </div>
          </label>
        </div>
        <div class="db-collection-card" data-collection="sessions">
          <label class="db-collection-label">
            <input type="checkbox" class="collection-checkbox" data-collection="sessions">
            <div class="db-collection-content">
              <div class="db-collection-icon" style="background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);">
                <i class="fa-solid fa-users"></i>
              </div>
              <div class="db-collection-info">
                <h4>Sessions</h4>
                <p>User session tracking data</p>
              </div>
            </div>
            <div class="db-collection-check">
              <i class="fa-solid fa-circle-check"></i>
            </div>
          </label>
        </div>
        <div class="db-collection-card" data-collection="uptime_checks">
          <label class="db-collection-label">
            <input type="checkbox" class="collection-checkbox" data-collection="uptime_checks">
            <div class="db-collection-content">
              <div class="db-collection-icon" style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);">
                <i class="fa-solid fa-heart-pulse"></i>
              </div>
              <div class="db-collection-info">
                <h4>Uptime Checks</h4>
                <p>Website availability monitoring</p>
              </div>
            </div>
            <div class="db-collection-check">
              <i class="fa-solid fa-circle-check"></i>
            </div>
          </label>
        </div>
        <div class="db-collection-card" data-collection="uptime_incidents">
          <label class="db-collection-label">
            <input type="checkbox" class="collection-checkbox" data-collection="uptime_incidents">
            <div class="db-collection-content">
              <div class="db-collection-icon" style="background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%);">
                <i class="fa-solid fa-circle-exclamation"></i>
              </div>
              <div class="db-collection-info">
                <h4>Uptime Incidents</h4>
                <p>Downtime event records</p>
              </div>
            </div>
            <div class="db-collection-check">
              <i class="fa-solid fa-circle-check"></i>
            </div>
          </label>
        </div>
        <div class="db-collection-card" data-collection="uptime_sum">
          <label class="db-collection-label">
            <input type="checkbox" class="collection-checkbox" data-collection="uptime_sum">
            <div class="db-collection-content">
              <div class="db-collection-icon" style="background: linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%);">
                <i class="fa-solid fa-chart-line"></i>
              </div>
              <div class="db-collection-info">
                <h4>Uptime Summaries</h4>
                <p>Aggregated uptime statistics</p>
              </div>
            </div>
            <div class="db-collection-check">
              <i class="fa-solid fa-circle-check"></i>
            </div>
          </label>
        </div>
        <div class="db-collection-card" data-collection="visitors">
          <label class="db-collection-label">
            <input type="checkbox" class="collection-checkbox" data-collection="visitors">
            <div class="db-collection-content">
              <div class="db-collection-icon" style="background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);">
                <i class="fa-solid fa-user"></i>
              </div>
              <div class="db-collection-info">
                <h4>Visitors</h4>
                <p>Unique visitor identification data</p>
              </div>
            </div>
            <div class="db-collection-check">
              <i class="fa-solid fa-circle-check"></i>
            </div>
          </label>
        </div>
        <div class="db-collection-card" data-collection="websites">
          <label class="db-collection-label">
            <input type="checkbox" class="collection-checkbox" data-collection="websites">
            <div class="db-collection-content">
              <div class="db-collection-icon" style="background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);">
                <i class="fa-solid fa-globe"></i>
              </div>
              <div class="db-collection-info">
                <h4>Websites</h4>
                <p>Registered website configurations</p>
              </div>
            </div>
            <div class="db-collection-check">
              <i class="fa-solid fa-circle-check"></i>
            </div>
          </label>
        </div>
      </div>

      <div class="db-drawer-actions">
        <button type="button" class="btn btn-secondary" onclick="closeDataManagementDrawer()">
          <i class="fa-solid fa-xmark"></i> Cancel
        </button>
        <button type="button" class="btn btn-danger" onclick="deleteSelectedCollections()">
          <i class="fa-solid fa-trash"></i> Delete Selected Data
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="test-modal-overlay"></div>

<div class="modal-dialog" id="pagespeed-test-modal">
  <div class="modal-header">
    <h3>Test PageSpeed API Connection</h3>
    <button class="modal-close" onclick="closeTestModal()">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <div class="modal-content">
    <p style="margin-bottom: 1rem; color: var(--text-secondary);">Enter a website URL to test the PageSpeed Insights API connection.</p>
    <form id="pagespeed-test-form" onsubmit="submitPageSpeedTest(event)">
      <div class="form-group" style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Website URL</label>
        <input type="url" id="pagespeed-url" class="settings-input" placeholder="https://example.com" required 
          style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
        <input type="checkbox" id="use-current-url" style="width: auto;" onchange="handleUseCurrentUrl(this.checked)">
        <label for="use-current-url" style="margin: 0; cursor: pointer; color: var(--text-secondary);">Use current URL</label>
      </div>
      <div id="pagespeed-test-result" style="margin-top: 1rem; display: none;"></div>
      <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
        <button type="button" class="btn btn-secondary" onclick="closeTestModal()" style="flex: 1;">Cancel</button>
        <button type="submit" class="btn btn-primary" style="flex: 1;">
          <i class="fa-solid fa-flask"></i> Test
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal-dialog" id="chapybara-test-modal">
  <div class="modal-header">
    <h3>Test Chapybara API Connection</h3>
    <button class="modal-close" onclick="closeTestModal()">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <div class="modal-content">
    <p style="margin-bottom: 1rem; color: var(--text-secondary);">Enter an IP address to test the Chapybara API connection.</p>
    <form id="chapybara-test-form" onsubmit="submitChapybaraTest(event)">
      <div class="form-group" style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">IP Address</label>
        <input type="text" id="chapybara-ip" class="settings-input" placeholder="8.8.8.8" required 
          style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
        <input type="checkbox" id="use-current-ip" style="width: auto;" onchange="handleUseCurrentIp(this.checked)">
        <label for="use-current-ip" style="margin: 0; cursor: pointer; color: var(--text-secondary);">Use current IP address</label>
      </div>
      <div id="chapybara-test-result" style="margin-top: 1rem; display: none;"></div>
      <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
        <button type="button" class="btn btn-secondary" onclick="closeTestModal()" style="flex: 1;">Cancel</button>
        <button type="submit" class="btn btn-primary" style="flex: 1;">
          <i class="fa-solid fa-flask"></i> Test
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal-dialog" id="resend-test-modal">
  <div class="modal-header">
    <h3>Test Resend Email API Connection</h3>
    <button class="modal-close" onclick="closeTestModal()">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <div class="modal-content">
    <p style="margin-bottom: 1rem; color: var(--text-secondary);">Send a test email to verify the Resend API connection.</p>
    <form id="resend-test-form" onsubmit="submitResendTest(event)">
      <div class="form-group" style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Recipient Email</label>
        <input type="email" id="resend-recipient" class="settings-input" placeholder="you@example.com" required 
          style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
      </div>
      <% 
        const resendFromEmail = apiKeys?.find(k => k.service === 'resend' && k.isActive)?.metadata?.fromEmail;
        if (resendFromEmail) { 
          const domain = resendFromEmail.split('@')[1];
      %>
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
          <input type="checkbox" id="use-notification-email" style="width: auto;" onchange="handleUseNotificationEmail(this.checked, 'skopos@<%= domain %>')">
          <label for="use-notification-email" style="margin: 0; cursor: pointer; color: var(--text-secondary);">Use skopos@<%= domain %></label>
        </div>
      <% } %>
      <div class="form-group" style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email Subject</label>
        <input type="text" id="resend-subject" class="settings-input" value="Skopos Test Email" 
          style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
      </div>
      <div class="form-group" style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email Body (HTML)</label>
        <textarea id="resend-body" class="settings-input" rows="6" 
          style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); font-family: monospace; resize: vertical;"><h1>Test Email</h1><p>This is a test email from Skopos to verify your Resend API configuration.</p></textarea>
      </div>
      <div id="resend-test-result" style="margin-top: 1rem; display: none;"></div>
      <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
        <button type="button" class="btn btn-secondary" onclick="closeTestModal()" style="flex: 1;">Cancel</button>
        <button type="submit" class="btn btn-primary" style="flex: 1;">
          <i class="fa-solid fa-paper-plane"></i> Send Test
        </button>
      </div>
    </form>
  </div>
</div>

<%- include('partials/footer', { scripts: ['settings'] }) %>
