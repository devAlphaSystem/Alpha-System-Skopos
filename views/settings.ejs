<%- include('partials/header', {title: 'Settings'}) %>

<%- include('partials/mobile-header') %>

<div class="page-wrapper">
  <%- include('partials/sidebar', { currentPage: 'settings', websites: websites, currentWebsite: null, user: user }) %>
  <div class="main-container">
    <div class="main-header">
      <div class="header-content">
        <div class="header-title">
          <h1>App Settings</h1>
          <p>Manage your application preferences</p>
        </div>
      </div>
    </div>
    
    <main class="main-content" style="padding-top: 1rem;">
      <div class="tabs-card">
        <div class="tabs-header">
          <button class="tab-button active" data-tab="appearance">
            <i class="fa-solid fa-palette"></i>
            <span>Appearance</span>
          </button>
          <button class="tab-button" data-tab="dashboard">
            <i class="fa-solid fa-chart-line"></i>
            <span>Dashboard</span>
          </button>
          <% if (typeof isMobile === 'undefined' || !isMobile) { %>
          <button class="tab-button" data-tab="privacy">
            <i class="fa-solid fa-shield-halved"></i>
            <span>Privacy</span>
          </button>
          <button class="tab-button" data-tab="api-keys">
            <i class="fa-solid fa-key"></i>
            <span>API Keys</span>
          </button>
          <% if (apiKeys?.find(k => k.service === 'resend' && k.isActive)) { %>
            <button class="tab-button" data-tab="notifications">
              <i class="fa-solid fa-bell"></i>
              <span>Notifications</span>
            </button>
          <% } %>
          <% } %>
        </div>

        <div class="tabs-body">
          <section class="tab-panel active" id="appearance-panel">
            <div class="settings-group">
              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Dark Mode</div>
                  <div class="settings-option-description">Switch between light and dark themes.</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="theme-toggle">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Toast Notifications</div>
                  <div class="settings-option-description">Show small notifications when settings are updated.</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="toasts-toggle">
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
          </section>

          <section class="tab-panel" id="dashboard-panel">
            <div class="settings-group">
              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Auto Refresh</div>
                  <div class="settings-option-description">Automatically pull the latest dashboard metrics.</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="auto-refresh-toggle">
                  <span class="toggle-slider"></span>
                </label>
              </div>

              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Refresh Interval</div>
                  <div class="settings-option-description">Choose how often we refresh the data.</div>
                </div>
                <select id="refresh-rate-select" class="settings-select">
                  <option value="0">Instant</option>
                  <option value="10000">10 seconds</option>
                  <option value="30000">30 seconds</option>
                  <option value="60000">1 minute</option>
                  <option value="300000">5 minutes</option>
                  <option value="900000">15 minutes</option>
                  <option value="1800000">30 minutes</option>
                </select>
              </div>
              
              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Data Period</div>
                  <div class="settings-option-description">Number of trailing days included in reports.</div>
                </div>
                <select id="data-period-select" class="settings-select">
                  <option value="1">Today</option>
                  <option value="7">7 days</option>
                  <option value="15">15 days</option>
                  <option value="30">30 days</option>
                </select>
              </div>

              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Results Per Card</div>
                  <div class="settings-option-description">How many entries to surface inside each report card.</div>
                </div>
                <select id="results-limit-select" class="settings-select">
                  <option value="5">5 results</option>
                  <option value="10">10 results</option>
                  <option value="25">25 results</option>
                </select>
              </div>

              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Show Unique Visitors</div>
                  <div class="settings-option-description">When enabled, the Visitors card shows only unique visitors (excludes returning visitors).</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="unique-visitors-toggle">
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
          </section>

          <% if (typeof isMobile === 'undefined' || !isMobile) { %>
          <section class="tab-panel" id="privacy-panel">
            <div class="settings-group">
              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Store Raw IP Addresses</div>
                  <div class="settings-option-description">Enable to store and display full IP addresses. When disabled, only hashed visitor IDs are stored for privacy.</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="store-raw-ip-toggle" <%= appSettings?.storeRawIp ? 'checked' : '' %>>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="settings-option">
                <div class="settings-option-info">
                  <div class="settings-option-label">Discard Short Sessions</div>
                  <div class="settings-option-description">When enabled, sessions with a duration of less than 1 second will be detected within 5 minutes and discarded.</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="discard-short-sessions-toggle" <%= appSettings?.discardShortSessions ? 'checked' : '' %>>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
          </section>

          <section class="tab-panel" id="api-keys-panel">
            <div class="settings-group">
              <div class="api-key-section">
                <div class="api-key-header">
                  <h4 style="margin: 0; color: var(--text-primary);">
                    <i class="fa-brands fa-google" style="margin-right: 0.5rem; color: #4285f4;"></i>
                    Google PageSpeed Insights
                  </h4>
                  <% 
                    const pagespeedKey = apiKeys?.find(k => k.service === 'google_pagespeed' && k.isActive);
                  %>
                  <% if (pagespeedKey) { %>
                    <span class="api-key-status" style="color: var(--success);">
                      <i class="fa-solid fa-circle-check"></i> Configured
                    </span>
                  <% } else { %>
                    <span class="api-key-status" style="color: var(--text-muted);">
                      <i class="fa-solid fa-circle-xmark"></i> Not configured
                    </span>
                  <% } %>
                </div>
                
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                  Required for comprehensive SEO and performance analysis. 
                  <a href="https://developers.google.com/speed/docs/insights/v5/get-started" target="_blank" rel="noopener noreferrer" style="color: var(--primary);">Get your API key</a>
                </p>

                <% if (pagespeedKey) { %>
                  <div class="api-key-card">
                    <div class="api-key-card-row">
                      <span style="font-size: 0.875rem; color: var(--text-secondary);">Key ID: <%= pagespeedKey.id.substring(0, 8) %>...</span>
                      <div class="api-key-actions">
                        <button class="btn btn-primary btn-sm" onclick="testPageSpeedConnection()">
                          <i class="fa-solid fa-flask"></i> Test Connection
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteApiKey('<%= pagespeedKey.id %>', 'google_pagespeed')">
                          <i class="fa-solid fa-trash"></i> Remove
                        </button>
                      </div>
                    </div>
                    <div class="api-key-meta">
                      <span class="api-key-usage">Used <%= pagespeedKey.usageCount || 0 %> times</span>
                      <% if (pagespeedKey.lastUsed) { %>
                        <span class="api-key-last-used">Last used: <%= new Date(pagespeedKey.lastUsed).toLocaleDateString() %></span>
                      <% } %>
                    </div>
                  </div>
                <% } else { %>
                  <form id="pagespeed-form" class="api-key-form" onsubmit="addApiKey(event, 'google_pagespeed')">
                    <input type="text" name="apiKey" class="settings-input" placeholder="AIza..." required style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-primary);">
                    <button type="submit" class="btn btn-primary" style="white-space: nowrap;">
                      <i class="fa-solid fa-save"></i> Save Key
                    </button>
                  </form>
                <% } %>
              </div>

              <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 1rem 0;">

              <div class="api-key-section">
                <div class="api-key-header">
                  <h4 style="margin: 0; color: var(--text-primary);">
                    <img src="/img/vendors/chapybara.png" alt="Chapybara" style="width: 24px; height: 24px; margin-right: 0.5rem; vertical-align: middle; border-radius: 4px;">
                    Chapybara IP Intelligence
                  </h4>
                  <% 
                    const chapybaraKey = apiKeys?.find(k => k.service === 'chapybara' && k.isActive);
                  %>
                  <% if (chapybaraKey) { %>
                    <span class="api-key-status" style="color: var(--success);">
                      <i class="fa-solid fa-circle-check"></i> Configured
                    </span>
                  <% } else { %>
                    <span class="api-key-status" style="color: var(--text-muted);">
                      <i class="fa-solid fa-circle-xmark"></i> Not configured
                    </span>
                  <% } %>
                </div>
                
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                  Get detailed IP intelligence including geolocation, ISP, security threat detection, and more. 
                  <a href="https://chapyapi.com" target="_blank" rel="noopener noreferrer" style="color: var(--primary);">Get your API key</a>
                </p>

                <% if (chapybaraKey) { %>
                  <div class="api-key-card">
                    <div class="api-key-card-row">
                      <span style="font-size: 0.875rem; color: var(--text-secondary);">Key ID: <%= chapybaraKey.id.substring(0, 8) %>...</span>
                      <div class="api-key-actions">
                        <button class="btn btn-primary btn-sm" onclick="testChapybaraConnection()">
                          <i class="fa-solid fa-flask"></i> Test Connection
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteApiKey('<%= chapybaraKey.id %>', 'chapybara')">
                          <i class="fa-solid fa-trash"></i> Remove
                        </button>
                      </div>
                    </div>
                    <div class="api-key-meta">
                      <span class="api-key-usage">Used <%= chapybaraKey.usageCount || 0 %> times</span>
                      <% if (chapybaraKey.lastUsed) { %>
                        <span class="api-key-last-used">Last used: <%= new Date(chapybaraKey.lastUsed).toLocaleDateString() %></span>
                      <% } %>
                    </div>
                  </div>
                <% } else { %>
                  <form id="chapybara-form" class="api-key-form" onsubmit="addApiKey(event, 'chapybara')">
                    <input type="text" name="apiKey" class="settings-input" placeholder="ck_..." required style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-primary);">
                    <button type="submit" class="btn btn-primary" style="white-space: nowrap;">
                      <i class="fa-solid fa-save"></i> Save Key
                    </button>
                  </form>
                <% } %>
              </div>

              <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 1rem 0;">

              <div class="api-key-section">
                <div class="api-key-header">
                  <h4 style="margin: 0; color: var(--text-primary);">
                    <img src="/img/vendors/resend.svg" alt="Resend" style="width: 24px; height: 24px; margin-right: 0.5rem; vertical-align: middle; filter: brightness(0) saturate(100%) invert(40%) sepia(95%) saturate(2387%) hue-rotate(210deg) brightness(94%) contrast(95%);">
                    Resend Email Service
                  </h4>
                  <% 
                    const resendKey = apiKeys?.find(k => k.service === 'resend' && k.isActive);
                  %>
                  <% if (resendKey) { %>
                    <span class="api-key-status" style="color: var(--success);">
                      <i class="fa-solid fa-circle-check"></i> Configured
                    </span>
                  <% } else { %>
                    <span class="api-key-status" style="color: var(--text-muted);">
                      <i class="fa-solid fa-circle-xmark"></i> Not configured
                    </span>
                  <% } %>
                </div>
                
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                  Required for sending email notifications about events, visitors, and analytics. 
                  <a href="https://resend.com/api-keys" target="_blank" rel="noopener noreferrer" style="color: var(--primary);">Get your API key</a>
                </p>

                <% if (resendKey) { %>
                  <div class="api-key-card">
                    <div class="api-key-card-row">
                      <div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">Key ID: <%= resendKey.id.substring(0, 8) %>...</div>
                        <% if (resendKey.metadata?.fromEmail) { %>
                          <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">From: <%= resendKey.metadata.fromEmail %></div>
                        <% } %>
                      </div>
                      <div class="api-key-actions">
                        <button class="btn btn-primary btn-sm" onclick="testResendConnection()">
                          <i class="fa-solid fa-flask"></i> Test Connection
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteApiKey('<%= resendKey.id %>', 'resend')">
                          <i class="fa-solid fa-trash"></i> Remove
                        </button>
                      </div>
                    </div>
                    <div class="api-key-meta">
                      <span class="api-key-usage">Used <%= resendKey.usageCount || 0 %> times</span>
                      <% if (resendKey.lastUsed) { %>
                        <span class="api-key-last-used">Last used: <%= new Date(resendKey.lastUsed).toLocaleDateString() %></span>
                      <% } %>
                    </div>
                  </div>
                <% } else { %>
                  <form id="resend-form" onsubmit="addApiKey(event, 'resend')" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div>
                      <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); font-weight: 500;">API Key</label>
                      <input type="text" name="apiKey" class="settings-input" placeholder="re_..." required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-primary);">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); font-weight: 500;">From Email</label>
                      <input type="email" name="fromEmail" class="settings-input" placeholder="notifications@yourdomain.com" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-primary);">
                      <small style="display: block; margin-top: 0.25rem; color: var(--text-muted); font-size: 0.75rem;">Must be a verified domain in your Resend account</small>
                    </div>
                    <button type="submit" class="btn btn-primary" style="align-self: flex-start;">
                      <i class="fa-solid fa-save"></i> Save Configuration
                    </button>
                  </form>
                <% } %>
              </div>
            </div>
          </section>
          <% } %>

          <% if (typeof isMobile === 'undefined' || !isMobile) { %>
          <section class="tab-panel" id="notifications-panel">
            <div class="settings-group">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding: 1rem 0;">
                <div>
                  <h3 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">Notification Rules</h3>
                  <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                    Configure email notifications for important events on your websites.
                  </p>
                  <p class="notifications-mobile-note">Rule creation and manipulation is available on the desktop experience.</p>
                </div>
                <button class="btn btn-primary notifications-desktop-button" onclick="showAddNotificationModal()">
                  <i class="fa-solid fa-plus"></i> Add Rule
                </button>
              </div>
              <div class="notifications-desktop-only">
                <% if (!apiKeys?.find(k => k.service === 'resend' && k.isActive)) { %>
                  <div style="padding: 1.5rem; background: var(--warning-bg, #FEF3C7); border-radius: 8px; border: 1px solid var(--warning-border, #FCD34D); margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: start; gap: 1rem;">
                      <i class="fa-solid fa-triangle-exclamation" style="color: #F59E0B; font-size: 1.5rem; margin-top: 0.25rem;"></i>
                      <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: #92400E;">Resend API Key Required</h4>
                        <p style="margin: 0; color: #92400E; font-size: 0.875rem;">
                          You need to configure a Resend API key in the <strong>API Keys</strong> tab before you can create notification rules.
                        </p>
                      </div>
                    </div>
                  </div>
                <% } %>

                <div id="notifications-table-container">
                  <table class="data-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="background: var(--card-bg); border-bottom: 2px solid var(--border-color);">
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-primary);">Name</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-primary);">Event Type</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-primary);">Recipient</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-primary);">Website</th>
                        <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--text-primary);">Status</th>
                        <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--text-primary);">Triggered</th>
                        <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--text-primary);">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="notifications-table-body">
                      <tr>
                        <td colspan="7" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                          <i class="fa-solid fa-bell-slash" style="font-size: 2rem; opacity: 0.3; display: block; margin-bottom: 0.5rem;"></i>
                          <span style="display: block; margin-top: 0.5rem;">No notification rules configured yet.</span>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>
          <% } %>

        </div>
      </div>
    </main>
  </div>
</div>

<% if (typeof isMobile === 'undefined' || !isMobile) { %>
<div class="drawer-overlay" id="notification-drawer-overlay"></div>

<div class="drawer" id="notification-drawer">
  <div class="drawer-header">
    <h2>Add Notification Rule</h2>
    <button class="drawer-close" id="notification-drawer-close"><i class="fa-solid fa-xmark"></i></button>
  </div>
  <div class="drawer-content">
    <form id="notification-form" onsubmit="saveNotificationRule(event)">
      <div class="settings-group">
        <div class="form-group" style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
            Rule Name <span style="color: var(--danger);">*</span>
          </label>
          <input type="text" name="name" class="settings-input" placeholder="e.g., New Visitor Alert" required 
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
        </div>

        <div class="form-group" style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
            Event Type <span style="color: var(--danger);">*</span>
          </label>
          <select name="eventType" class="settings-select" required onchange="handleEventTypeChange(this.value)" style="width: 100%;">
            <option value="">Select an event type...</option>
            <option value="new_visitor">New Visitor Registered</option>
            <option value="custom_event">Custom Event Triggered</option>
            <option value="new_session">New Session Started</option>
            <option value="daily_summary">Daily Summary Report</option>
            <option value="error_threshold">Error Threshold Exceeded</option>
            <option value="uptime_status">Website Uptime Change</option>
          </select>
        </div>

        <div id="custom-event-name-group" class="form-group" style="margin-bottom: 1.5rem; display: none;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
            Custom Event Name <span style="color: var(--danger);">*</span>
          </label>
          <input type="text" name="customEventName" class="settings-input" placeholder="e.g., button_click" 
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
          <small style="display: block; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.875rem;">
            Enter the exact name of the custom event to monitor.
          </small>
        </div>

        <div id="uptime-event-settings" class="form-group" style="margin-bottom: 1.5rem; display: none;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
            Uptime Alert Options
          </label>
          <select name="uptimeNotifyOn" id="uptime-notify-on" class="settings-select" style="width: 100%;">
            <option value="down" selected>Notify when the website goes down</option>
            <option value="up">Notify when the website recovers</option>
            <option value="both">Notify for both downtime and recovery</option>
          </select>
          <small style="display: block; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.875rem;">
            Choose when Skopos should send uptime alerts.
          </small>
        </div>

        <div class="form-group" style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
            Recipient Email <span style="color: var(--danger);">*</span>
          </label>
          <input type="email" name="recipientEmail" class="settings-input" placeholder="you@example.com" required 
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
        </div>

        <div class="form-group" style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
            Website
          </label>
          <select name="website" class="settings-select" style="width: 100%;">
            <option value="">All Websites</option>
            <% if (websites && websites.length > 0) { %>
              <% websites.forEach(site => { %>
                <option value="<%= site.id %>"><%= site.name %></option>
              <% }); %>
            <% } %>
          </select>
          <small style="display: block; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.875rem;">
            Leave empty to apply to all websites.
          </small>
        </div>

        <div style="display: flex; gap: 0.75rem; margin-top: 2rem;">
          <button type="button" class="btn btn-secondary" onclick="closeNotificationDrawer()" style="flex: 1;">Cancel</button>
          <button type="submit" class="btn btn-primary" style="flex: 1;">
            <i class="fa-solid fa-save"></i> Save Rule
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="modal-overlay" id="test-modal-overlay"></div>

<div class="modal-dialog" id="pagespeed-test-modal">
  <div class="modal-header">
    <h3>Test PageSpeed API Connection</h3>
    <button class="modal-close" onclick="closeTestModal()">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <div class="modal-content">
    <p style="margin-bottom: 1rem; color: var(--text-secondary);">Enter a website URL to test the PageSpeed Insights API connection.</p>
    <form id="pagespeed-test-form" onsubmit="submitPageSpeedTest(event)">
      <div class="form-group" style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Website URL</label>
        <input type="url" id="pagespeed-url" class="settings-input" placeholder="https://example.com" required 
          style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
        <input type="checkbox" id="use-current-url" style="width: auto;" onchange="handleUseCurrentUrl(this.checked)">
        <label for="use-current-url" style="margin: 0; cursor: pointer; color: var(--text-secondary);">Use current URL</label>
      </div>
      <div id="pagespeed-test-result" style="margin-top: 1rem; display: none;"></div>
      <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
        <button type="button" class="btn btn-secondary" onclick="closeTestModal()" style="flex: 1;">Cancel</button>
        <button type="submit" class="btn btn-primary" style="flex: 1;">
          <i class="fa-solid fa-flask"></i> Test
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal-dialog" id="chapybara-test-modal">
  <div class="modal-header">
    <h3>Test Chapybara API Connection</h3>
    <button class="modal-close" onclick="closeTestModal()">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <div class="modal-content">
    <p style="margin-bottom: 1rem; color: var(--text-secondary);">Enter an IP address to test the Chapybara API connection.</p>
    <form id="chapybara-test-form" onsubmit="submitChapybaraTest(event)">
      <div class="form-group" style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">IP Address</label>
        <input type="text" id="chapybara-ip" class="settings-input" placeholder="8.8.8.8" required 
          style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
        <input type="checkbox" id="use-current-ip" style="width: auto;" onchange="handleUseCurrentIp(this.checked)">
        <label for="use-current-ip" style="margin: 0; cursor: pointer; color: var(--text-secondary);">Use current IP address</label>
      </div>
      <div id="chapybara-test-result" style="margin-top: 1rem; display: none;"></div>
      <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
        <button type="button" class="btn btn-secondary" onclick="closeTestModal()" style="flex: 1;">Cancel</button>
        <button type="submit" class="btn btn-primary" style="flex: 1;">
          <i class="fa-solid fa-flask"></i> Test
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal-dialog" id="resend-test-modal">
  <div class="modal-header">
    <h3>Test Resend Email API Connection</h3>
    <button class="modal-close" onclick="closeTestModal()">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <div class="modal-content">
    <p style="margin-bottom: 1rem; color: var(--text-secondary);">Send a test email to verify the Resend API connection.</p>
    <form id="resend-test-form" onsubmit="submitResendTest(event)">
      <div class="form-group" style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Recipient Email</label>
        <input type="email" id="resend-recipient" class="settings-input" placeholder="you@example.com" required 
          style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
      </div>
      <% 
        const resendFromEmail = apiKeys?.find(k => k.service === 'resend' && k.isActive)?.metadata?.fromEmail;
        if (resendFromEmail) { 
          const domain = resendFromEmail.split('@')[1];
      %>
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
          <input type="checkbox" id="use-notification-email" style="width: auto;" onchange="handleUseNotificationEmail(this.checked, 'skopos@<%= domain %>')">
          <label for="use-notification-email" style="margin: 0; cursor: pointer; color: var(--text-secondary);">Use skopos@<%= domain %></label>
        </div>
      <% } %>
      <div class="form-group" style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email Subject</label>
        <input type="text" id="resend-subject" class="settings-input" value="Skopos Test Email" 
          style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
      </div>
      <div class="form-group" style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email Body (HTML)</label>
        <textarea id="resend-body" class="settings-input" rows="6" 
          style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); font-family: monospace; resize: vertical;"><h1>Test Email</h1><p>This is a test email from Skopos to verify your Resend API configuration.</p></textarea>
      </div>
      <div id="resend-test-result" style="margin-top: 1rem; display: none;"></div>
      <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
        <button type="button" class="btn btn-secondary" onclick="closeTestModal()" style="flex: 1;">Cancel</button>
        <button type="submit" class="btn btn-primary" style="flex: 1;">
          <i class="fa-solid fa-paper-plane"></i> Send Test
        </button>
      </div>
    </form>
  </div>
</div>
<% } %>

<%- include('partials/footer', { scripts: ['settings'] }) %>
