<%- include('partials/header', {title: 'Sessions'}) %>

<%- include('partials/mobile-header') %>

<div class="page-wrapper">
  <%- include('partials/sidebar', { websites, archivedWebsites, currentWebsite, currentPage }) %>
  <div class="main-container">
    <header class="main-header">
      <div class="header-content">
        <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle Sidebar"><i class="fa-solid fa-bars"></i></button>
        <div class="header-title">
          <h1><%= currentWebsite.name %> - Sessions</h1>
          <p>View and manage all visitor sessions</p>
        </div>
      </div>
    </header>
    
    <main class="main-content" style="padding-top: 1rem;">
      <% if (visitorsWithSessions.length === 0 && pagination.currentPage === 1) { %>
        <div class="card no-data-card">
          <i class="fa-solid fa-triangle-exclamation"></i>
          <h2>No Sessions Available</h2>
          <p>No visitor sessions have been recorded for this website yet.</p>
        </div>
      <% } else { %>
        <div class="card">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <h2>All Visitor Sessions (<%= pagination.totalSessions %> total sessions)</h2>
            <div class="pagination-controls" style="display: flex; align-items: center; gap: 0.5rem;">
              <label for="per-page-select" style="font-size: 0.875rem; color: var(--text-secondary);">Per page:</label>
              <select id="per-page-select" class="settings-select">
                <option value="10" <%= pagination.perPage === 10 ? 'selected' : '' %>>10</option>
                <option value="25" <%= pagination.perPage === 25 ? 'selected' : '' %>>25</option>
                <option value="50" <%= pagination.perPage === 50 ? 'selected' : '' %>>50</option>
                <option value="100" <%= pagination.perPage === 100 ? 'selected' : '' %>>100</option>
              </select>
            </div>
          </div>
          <div class="sessions-container">
            <% for (const visitorData of visitorsWithSessions) { %>
              <div class="visitor-group">
                <div class="visitor-header">
                  <div class="visitor-info">
                    <% if (visitorData.userName || visitorData.userEmail) { %>
                      <h3>
                        <i class="fa-solid fa-user" style="color: var(--primary-color); margin-right: 0.5rem;"></i>
                        <% if (visitorData.userName) { %>
                          <%= visitorData.userName %>
                        <% } %>
                        <% if (visitorData.userEmail) { %>
                          <span style="color: var(--text-muted); font-size: 0.9em;">(<%= visitorData.userEmail %>)</span>
                        <% } %>
                      </h3>
                      <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.25rem;">
                        <span class="visitor-id-badge">ID: <code><%= visitorData.visitorId.substring(0, 16) %>...</code></span>
                        <% if (visitorData.userId) { %>
                          <span class="visitor-id-badge" style="background: var(--success-bg); color: var(--success-color);">
                            <i class="fa-solid fa-check-circle"></i> Identified User
                          </span>
                        <% } %>
                        <span class="visitor-sessions-count"><%= visitorData.sessions.length %> session<%= visitorData.sessions.length !== 1 ? 's' : '' %></span>
                      </div>
                    <% } else { %>
                      <h3>
                        <i class="fa-solid fa-user-secret" style="color: var(--text-muted); margin-right: 0.5rem;"></i>
                        Anonymous Visitor
                      </h3>
                      <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.25rem;">
                        <span class="visitor-id-badge"><code><%= visitorData.visitorId.substring(0, 16) %>...</code></span>
                        <span class="visitor-sessions-count"><%= visitorData.sessions.length %> session<%= visitorData.sessions.length !== 1 ? 's' : '' %></span>
                      </div>
                    <% } %>
                  </div>
                  <% if (typeof isMobile === 'undefined' || !isMobile) { %>
                  <form action="/sessions/<%= currentWebsite.id %>/visitor/<%= visitorData.visitorRecordId %>/delete" method="POST" style="display: inline;">
                    <button type="submit" class="btn-icon btn-danger delete-visitor-btn" data-visitor-id="<%= visitorData.visitorId %>" title="Delete all sessions for this visitor"><i class="fa-solid fa-trash"></i></button>
                  </form>
                  <% } %>
                </div>
                <div class="sessions-list">
                  <% for (const session of visitorData.sessions) { %>
                    <div class="session-item" onclick="if (!event.target.closest('.session-actions')) { window.location.href='/sessions/<%= currentWebsite.id %>/session/<%= session.sessionId %>'; }">
                      <div class="session-main-info">
                        <div class="session-time">
                          <div class="session-meta">
                            <i class="fa-solid fa-clock"></i>
                            <span><strong>Started:</strong> <%= new Date(session.startTime).toLocaleString() %></span>
                          </div>
                          <div class="session-meta">
                            <i class="fa-solid fa-hourglass-end"></i>
                            <span><strong>Ended:</strong> <%= new Date(session.endTime).toLocaleString() %></span>
                          </div>
                        </div>
                        <div class="session-stats">
                          <div class="session-stat">
                            <i class="fa-solid fa-stopwatch"></i>
                            <span><%= session.duration %></span>
                          </div>
                          <div class="session-stat">
                            <i class="fa-solid fa-file-lines"></i>
                            <span><%= session.pagesVisited %> pages</span>
                          </div>
                          <% if (session.isNewVisitor) { %>
                            <div class="session-badge new-visitor">New Visitor</div>
                          <% } %>
                        </div>
                      </div>
                      <div class="session-device-info">
                        <div class="session-detail">
                          <i class="fa-solid fa-desktop"></i>
                          <span><%= session.device || 'Unknown' %></span>
                        </div>
                        <div class="session-detail">
                          <i class="fa-brands fa-<%= session.browser ? session.browser.toLowerCase().replace(/[^a-z]/g, '') : 'chrome' %>"></i>
                          <span><%= session.browser || 'Unknown' %></span>
                        </div>
                        <div class="session-detail">
                          <i class="fa-solid fa-globe"></i>
                          <span><%= session.country || 'Unknown' %></span>
                        </div>
                        <% if (session.ipAddress) { %>
                        <div class="session-detail">
                          <i class="fa-solid fa-network-wired"></i>
                          <span><%= session.ipAddress %></span>
                        </div>
                        <% } %>
                      </div>
                      <% if (typeof isMobile === 'undefined' || !isMobile) { %>
                      <div class="session-actions">
                        <form action="/sessions/<%= currentWebsite.id %>/session/<%= session.sessionId %>/delete" method="POST">
                          <button type="submit" class="btn-icon btn-danger delete-session-btn" data-session-id="<%= session.sessionId %>" title="Delete this session"><i class="fa-solid fa-trash"></i></button>
                        </form>
                      </div>
                      <% } %>
                    </div>
                  <% } %>
                </div>
              </div>
            <% } %>
          </div>
          
          <% if (pagination.totalPages > 1) { %>
          <div class="pagination-wrapper">
            <div class="pagination-info">
              Showing <%= pagination.startItem %>-<%= pagination.endItem %> of <%= pagination.totalSessions %> sessions
            </div>
            <div class="pagination-buttons">
              <% if (pagination.hasPrevPage) { %>
                <a href="/sessions/<%= currentWebsite.id %>?page=1&perPage=<%= pagination.perPage %>" class="btn btn-sm btn-secondary" title="First page">
                  <i class="fa-solid fa-angles-left"></i>
                </a>
                <a href="/sessions/<%= currentWebsite.id %>?page=<%= pagination.currentPage - 1 %>&perPage=<%= pagination.perPage %>" class="btn btn-sm btn-secondary" title="Previous page">
                  <i class="fa-solid fa-chevron-left"></i>
                </a>
              <% } else { %>
                <button class="btn btn-sm btn-secondary" disabled><i class="fa-solid fa-angles-left"></i></button>
                <button class="btn btn-sm btn-secondary" disabled><i class="fa-solid fa-chevron-left"></i></button>
              <% } %>
              
              <% 
                const maxVisiblePages = 5;
                let startPage = Math.max(1, pagination.currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(pagination.totalPages, startPage + maxVisiblePages - 1);
                if (endPage - startPage + 1 < maxVisiblePages) {
                  startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
              %>
              
              <% if (startPage > 1) { %>
                <span style="padding: 0 0.5rem; color: var(--text-muted);">...</span>
              <% } %>
              
              <% for (let p = startPage; p <= endPage; p++) { %>
                <a href="/sessions/<%= currentWebsite.id %>?page=<%= p %>&perPage=<%= pagination.perPage %>" 
                   class="btn btn-sm <%= p === pagination.currentPage ? 'btn-primary' : 'btn-secondary' %>"
                   style="min-width: 2.5rem;">
                  <%= p %>
                </a>
              <% } %>
              
              <% if (endPage < pagination.totalPages) { %>
                <span style="padding: 0 0.5rem; color: var(--text-muted);">...</span>
              <% } %>
              
              <% if (pagination.hasNextPage) { %>
                <a href="/sessions/<%= currentWebsite.id %>?page=<%= pagination.currentPage + 1 %>&perPage=<%= pagination.perPage %>" class="btn btn-sm btn-secondary" title="Next page">
                  <i class="fa-solid fa-chevron-right"></i>
                </a>
                <a href="/sessions/<%= currentWebsite.id %>?page=<%= pagination.totalPages %>&perPage=<%= pagination.perPage %>" class="btn btn-sm btn-secondary" title="Last page">
                  <i class="fa-solid fa-angles-right"></i>
                </a>
              <% } else { %>
                <button class="btn btn-sm btn-secondary" disabled><i class="fa-solid fa-chevron-right"></i></button>
                <button class="btn btn-sm btn-secondary" disabled><i class="fa-solid fa-angles-right"></i></button>
              <% } %>
            </div>
          </div>
          <% } %>
        </div>
      <% } %>
    </main>
  </div>
</div>

<%- include('partials/footer', { scripts: ['sessions'] }) %>