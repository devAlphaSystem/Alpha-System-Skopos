<%- include('partials/header', {title: 'Sessions'}) %>

<div class="page-wrapper">
  <%- include('partials/sidebar', { websites, archivedWebsites, currentWebsite, currentPage }) %>
  <div class="main-container">
    <header class="main-header">
      <div class="header-content">
        <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle Sidebar"><i class="fa-solid fa-bars"></i></button>
        <div class="header-title">
          <h1><%= currentWebsite.name %> - Sessions</h1>
          <p>View and manage all visitor sessions</p>
        </div>
        <div class="header-actions">
          <a href="/dashboard/<%= currentWebsite.id %>" class="btn-icon" title="Back to Dashboard"><i class="fa-solid fa-arrow-left"></i></a>
        </div>
      </div>
    </header>
    
    <main class="main-content" style="padding-top: 1rem;">
      <% if (visitorsWithSessions.length === 0) { %>
        <div class="card no-data-card">
          <i class="fa-solid fa-triangle-exclamation"></i>
          <h2>No Sessions Available</h2>
          <p>No visitor sessions have been recorded for this website yet.</p>
        </div>
      <% } else { %>
        <div class="card">
          <div class="card-header">
            <h2>All Visitor Sessions (<%= visitorsWithSessions.reduce((sum, v) => sum + v.sessions.length, 0) %> sessions from <%= visitorsWithSessions.length %> visitors)</h2>
          </div>
          <div class="sessions-container">
            <% for (const visitorData of visitorsWithSessions) { %>
              <div class="visitor-group">
                <div class="visitor-header">
                  <div class="visitor-info">
                    <h3>Visitor: <code><%= visitorData.visitorId.substring(0, 16) %>...</code></h3>
                    <span class="visitor-sessions-count"><%= visitorData.sessions.length %> session<%= visitorData.sessions.length !== 1 ? 's' : '' %></span>
                  </div>
                  <form action="/sessions/<%= currentWebsite.id %>/visitor/<%= visitorData.visitorRecordId %>/delete" method="POST" style="display: inline;">
                    <button type="submit" class="btn-icon btn-danger delete-visitor-btn" data-visitor-id="<%= visitorData.visitorId %>" title="Delete all sessions for this visitor"><i class="fa-solid fa-trash"></i></button>
                  </form>
                </div>
                <div class="sessions-list">
                  <% for (const session of visitorData.sessions) { %>
                    <div class="session-item" onclick="window.location.href='/sessions/<%= currentWebsite.id %>/session/<%= session.sessionId %>'">
                      <div class="session-main-info">
                        <div class="session-time">
                          <div class="session-meta">
                            <i class="fa-solid fa-clock"></i>
                            <span><strong>Started:</strong> <%= new Date(session.startTime).toLocaleString() %></span>
                          </div>
                          <div class="session-meta">
                            <i class="fa-solid fa-hourglass-end"></i>
                            <span><strong>Ended:</strong> <%= new Date(session.endTime).toLocaleString() %></span>
                          </div>
                        </div>
                        <div class="session-stats">
                          <div class="session-stat">
                            <i class="fa-solid fa-stopwatch"></i>
                            <span><%= session.duration %></span>
                          </div>
                          <div class="session-stat">
                            <i class="fa-solid fa-file-lines"></i>
                            <span><%= session.pagesVisited %> pages</span>
                          </div>
                          <% if (session.isNewVisitor) { %>
                            <div class="session-badge new-visitor">New Visitor</div>
                          <% } %>
                        </div>
                      </div>
                      <div class="session-device-info">
                        <div class="session-detail">
                          <i class="fa-solid fa-desktop"></i>
                          <span><%= session.device || 'Unknown' %></span>
                        </div>
                        <div class="session-detail">
                          <i class="fa-brands fa-<%= session.browser ? session.browser.toLowerCase().replace(/[^a-z]/g, '') : 'chrome' %>"></i>
                          <span><%= session.browser || 'Unknown' %></span>
                        </div>
                        <div class="session-detail">
                          <i class="fa-solid fa-globe"></i>
                          <span><%= session.country || 'Unknown' %></span>
                        </div>
                      </div>
                      <div class="session-actions" onclick="event.stopPropagation()">
                        <form action="/sessions/<%= currentWebsite.id %>/session/<%= session.sessionId %>/delete" method="POST">
                          <button type="submit" class="btn-icon btn-danger delete-session-btn" data-session-id="<%= session.sessionId %>" title="Delete this session"><i class="fa-solid fa-trash"></i></button>
                        </form>
                      </div>
                    </div>
                  <% } %>
                </div>
              </div>
            <% } %>
          </div>
        </div>
      <% } %>
    </main>
  </div>
</div>

<script>
  document.body.addEventListener("click", async (e) => {
    const deleteSessionButton = e.target.closest(".delete-session-btn");
    const deleteVisitorButton = e.target.closest(".delete-visitor-btn");

    if (deleteSessionButton && !deleteSessionButton.dataset.confirmed) {
      e.preventDefault();
      const form = deleteSessionButton.closest("form");
      if (!form) return;
      const sessionId = deleteSessionButton.dataset.sessionId;
      const confirmed = await window.customConfirm("Delete Session?", `Are you sure you want to delete this session? This action cannot be undone.`);
      if (confirmed) {
        deleteSessionButton.dataset.confirmed = "true";
        deleteSessionButton.click();
      }
    } else if (deleteSessionButton?.dataset.confirmed) {
      delete deleteSessionButton.dataset.confirmed;
    }

    if (deleteVisitorButton && !deleteVisitorButton.dataset.confirmed) {
      e.preventDefault();
      const form = deleteVisitorButton.closest("form");
      if (!form) return;
      const visitorId = deleteVisitorButton.dataset.visitorId;
      const confirmed = await window.customConfirm("Delete All Sessions?", `Are you sure you want to delete all sessions for visitor <strong>${visitorId.substring(0, 16)}...</strong>? This action cannot be undone.`);
      if (confirmed) {
        deleteVisitorButton.dataset.confirmed = "true";
        deleteVisitorButton.click();
      }
    } else if (deleteVisitorButton?.dataset.confirmed) {
      delete deleteVisitorButton.dataset.confirmed;
    }
  });
</script>

<%- include('partials/footer', { scripts: [] }) %>